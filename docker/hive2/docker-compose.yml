services:
  postgres-hive2:
    image: postgres:15
    container_name: postgres-hive2
    environment:
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: hive
      POSTGRES_DB: metastore_db
    ports:
      - "5432:5432"
    volumes:
      - hive2-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hive -d metastore_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - hive2-network

  hive2-metastore:
    image: bde2020/hive:2.3.2-postgresql-metastore
    container_name: hive2-metastore
    depends_on:
      postgres-hive2:
        condition: service_healthy
    environment:
      HIVE_SITE_CONF_javax_jdo_option_ConnectionURL: jdbc:postgresql://postgres-hive2:5432/metastore_db
      HIVE_SITE_CONF_javax_jdo_option_ConnectionDriverName: org.postgresql.Driver
      HIVE_SITE_CONF_javax_jdo_option_ConnectionUserName: hive
      HIVE_SITE_CONF_javax_jdo_option_ConnectionPassword: hive
      HIVE_SITE_CONF_datanucleus_autoCreateSchema: "true"
      HIVE_SITE_CONF_datanucleus_schema_autoCreateAll: "true"
      HIVE_SITE_CONF_hive_metastore_schema_verification: "false"
      HIVE_SITE_CONF_hive_metastore_uris: thrift://hive2-metastore:9083
      HIVE_SITE_CONF_hive_metastore_warehouse_dir: file:///user/hive/warehouse
      CORE_CONF_fs_defaultFS: file:///
      SERVICE_PRECONDITION: "postgres-hive2:5432"
    ports:
      - "9083:9083"
    volumes:
      - hive2-warehouse:/user/hive/warehouse
      - ./postgresql-42.7.3.jar:/opt/hive/lib/postgres.jar
    networks:
      - hive2-network
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/9083"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    command: /opt/hive/bin/hive --service metastore

volumes:
  hive2-postgres-data:
  hive2-warehouse:

networks:
  hive2-network:
    driver: bridge
