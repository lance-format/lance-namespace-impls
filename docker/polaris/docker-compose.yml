version: '3.8'

services:
  postgres-polaris:
    image: postgres:16
    container_name: postgres-polaris
    environment:
      POSTGRES_USER: polaris
      POSTGRES_PASSWORD: polaris
      POSTGRES_DB: polaris
    ports:
      - "5434:5432"
    volumes:
      - polaris-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U polaris -d polaris"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - polaris-network

  polaris:
    image: apache/polaris:latest
    container_name: polaris
    depends_on:
      postgres-polaris:
        condition: service_healthy
    environment:
      # Bootstrap credentials: realm,client_id,client_secret
      POLARIS_BOOTSTRAP_CREDENTIALS: "POLARIS,root,s3cr3t"
      # Persistence configuration
      POLARIS_PERSISTENCE_TYPE: relational-jdbc
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-polaris:5432/polaris
      QUARKUS_DATASOURCE_USERNAME: polaris
      QUARKUS_DATASOURCE_PASSWORD: polaris
      # Allow file:// storage for local testing
      POLARIS_FEATURES_DEFAULTS_OVERRIDE_ALLOW_INSECURE_STORAGE_TYPES: "true"
      POLARIS_FEATURES_DEFAULTS_OVERRIDE_SUPPORTED_CATALOG_STORAGE_TYPES: '["FILE","S3","GCS","AZURE"]'
      # Disable OpenTelemetry for testing
      QUARKUS_OTEL_SDK_DISABLED: "true"
    ports:
      - "8181:8181"
      - "8182:8182"
    volumes:
      - polaris-warehouse:/data/warehouse
    networks:
      - polaris-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8182/q/health"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

volumes:
  polaris-postgres-data:
  polaris-warehouse:

networks:
  polaris-network:
    driver: bridge
