services:
  postgres-polaris:
    image: postgres:16
    container_name: postgres-polaris
    environment:
      POSTGRES_USER: polaris
      POSTGRES_PASSWORD: polaris
      POSTGRES_DB: polaris
    ports:
      - "5434:5432"
    volumes:
      - polaris-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U polaris -d polaris"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - polaris-network

  polaris-bootstrap:
    image: apache/polaris-admin-tool:1.2.0-incubating
    container_name: polaris-bootstrap
    depends_on:
      postgres-polaris:
        condition: service_healthy
    environment:
      POLARIS_PERSISTENCE_TYPE: relational-jdbc
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-polaris:5432/polaris
      QUARKUS_DATASOURCE_USERNAME: polaris
      QUARKUS_DATASOURCE_PASSWORD: polaris
    command: ["bootstrap", "-r", "POLARIS", "-c", "POLARIS,root,s3cr3t"]
    networks:
      - polaris-network

  polaris:
    image: apache/polaris:1.2.0-incubating
    container_name: polaris
    depends_on:
      polaris-bootstrap:
        condition: service_completed_successfully
    environment:
      POLARIS_BOOTSTRAP_CREDENTIALS: "POLARIS,root,s3cr3t"
      POLARIS_PERSISTENCE_TYPE: relational-jdbc
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-polaris:5432/polaris
      QUARKUS_DATASOURCE_USERNAME: polaris
      QUARKUS_DATASOURCE_PASSWORD: polaris
      polaris.features."ALLOW_INSECURE_STORAGE_TYPES": "true"
      polaris.features."SUPPORTED_CATALOG_STORAGE_TYPES": '["FILE","S3","GCS","AZURE"]'
      polaris.features."GENERIC_TABLE_ENABLED": "true"
      polaris.readiness.ignore-severe-issues: "true"
      QUARKUS_OTEL_SDK_DISABLED: "true"
    ports:
      - "8181:8181"
      - "8182:8182"
    volumes:
      - polaris-warehouse:/data/warehouse
    networks:
      - polaris-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8182/q/health"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  polaris-setup:
    image: alpine:3.20
    container_name: polaris-setup
    depends_on:
      polaris:
        condition: service_healthy
    volumes:
      - ./init-catalog.sh:/init-catalog.sh:ro
    command: ["/bin/sh", "/init-catalog.sh"]
    networks:
      - polaris-network

volumes:
  polaris-postgres-data:
  polaris-warehouse:

networks:
  polaris-network:
    driver: bridge
